# Virus Host Prediction

Protein language model to predict the host of a given virus sequence.

Input: a viral protein sequence
Output: Probabilities for the $n$ different classes

## Repository Organization
- **deployment**
  - arc: shell scripts for deployments in arc
- **input**: 
    - config-files: yaml config files for data-preprocessing, prediction, and evaluation tasks.
    - data: raw fasta files of protein sequences and five independent splits with training and testing files
      - HEV virus protein sequences downloaded from
      - all mammlian and aves virus protein sequences download from UniRef90.
  raw: Folder containing raw protein sequences in fasta format. 
    - processed: Folder containing all preprocessed protein sequences with labels to be supplied as input to classification models.
- output: 
    - raw: Output files with predictions from the classification models.
    - evaluation: Intermediary output files with evaluation metric values generated by evaluation pipeline.
    - visualization: Result figures/visualizations.
    - logs: Log files generated during experiment executions.
- src: source code
---
## Data
Input protein sequence data used for all virus host prediction experiments are located at [input/data](input/data)

- [UniRef90](input/data/uniref90/20240131)
- [Coronaviridae Spike protein sequences](input/data/coronaviridae/20240313)
---
## Prerequisites:
### ARC Setup
- Request Dr. T. M. Murali to add you to the `seqevol` project in ARC.
- SSH into `tinkercliffs1.arc.vt.edu`.
- Clone the GitHub repository at the desired location.
- Instantiate conda environment
```shell
bash
conda create -n zoonosis
```
- Access input data files and pre-trained models
```shell
<Insert path to project folder>
```

### Install Dependencies
Install python dependencies via 
```shell 
pip install -R ./requirements.txt
pip install numpy --pre torch --index-url https://download.pytorch.org/whl/cu117
pip install -r requirements.txt
pip install pyyaml
conda install pandas
```
### Create required folders
Create a directory for logs using - 
```shell
mkdir -p output/logs
```
### Setup Weights & Biases
1. Create an account in [Weights & Biases](https://wandb.ai/site/).
2. Create a new project in Weights and Biases named `zoonosis-host-prediction`.
3. Setup the `wandb` library by completing [Step 1 in the Quickstart](https://wandb.ai/quickstart?utm_source=app-resource-center&utm_medium=app&utm_term=quickstart).
    - Note: Do not forget to log in to Weights and Biases (`wandb login`) in the server where you intend to execute the experiment.
---
## Usage
### General usage:
```shell
python src/zoonosis.py -c <path-to-config-file>
```
Example
```shell
python src/zoonosis.py -c 
```


### ARC Deployment
Choose the deployment script based on the use-case

Examples
- [zoonosis_gpu](deployment/arc/zoonosis_gpu.sh)
```shell
sbatch deployment/arc/zoonosis_gpu.sh . input/config-files/transfer_learning/fine_tuning/uniref90-fine-tuning-host-prediction-multi.yaml
```

- [misc_gpu](deployment/arc/misc_gpu.sh)
```shell
sbatch deployment/arc/zoonosis_gpu.sh . <path-to-script-to-executed> <arguments-required-by-the-script>
```

- Execute [perturbation_dataset_generator.py](src/utils/scripts/perturbation_dataset_generator.py) using [misc_gpu](deployment/arc/misc_gpu.sh)
```shell
sbatch deployment/arc/misc_gpu.sh . src/utils/scripts/perturbation_dataset_generator.py -if input/data/coronaviridae/20240313/sarscov2/uniprot/coronaviridae_s_uniprot_sars_cov_2.csv -od input/data/coronaviridae/20240313/sarscov2/uniprot/perturbation_dataset/multi -st protein
```
---
## Fine tuning VirProBERT for virus host multiclass classification
1. Create a config file for fine-tuning based on the example config in [uniref90-fine-tuning-host-prediction-multi.yaml](input/config-files/transfer_learning/fine_tuning/uniref90-fine-tuning-host-prediction-multi.yaml)
   1. Ensure that config type and subtypes are set as follows
    ```yaml
      config_type: "transfer_learning" # options: data_preprocessor, host_prediction, evaluation, transfer_learning
      config_sub_type: "host_prediction"
    ```
2. Configure a suitable experiment name to be used to reference the execution using the `experiment` parameter in the config.
3. Set the relative path to the input file(s) within `input_settings` using `input_dir` and `file_names` parameters.
4. Set the following sequence related parameters in `sequence_settings` with respect to the input data file -
   1. `id_col`: identifier column name
   2. `sequence_col`: Sequence column name
   3. `truncate`: Boolean (default: False) - should the sequence be truncated with respect to the configured maximum sequence length?
   4. `split_sequence`: Boolean (default: False) - should the sequence be *explicitly* segmented with respect to the configured maximum sequence length?
5. Set the path to the transformer-encoder pre-trained using masked language modeling and all related parameters in `pre_train_settings`
    1. Configure the transformer-encoder related parameters in `pre_train_settings.encoder_settings`
6. Configure the parameters related to fine-tuning the pre-trained model in `fine_tune_settings`
7. Configure the common names of the virus hosts species and other label related settings in `fine_tune_settings.label_settings`
8. The different types fine-tuning models can be configured in `task_settings` and each model can be activated using its `active` flag.
    1. `data_parallel`: Enable parallel execution on multiple GPUs if available.
9. Configure the output directory and the prefix to be used while naming the output file in `output_settings`
10. Execute the fine-tuning experiment using
    ```shell
        python src/zoonosis.py --config <path-to-the-config-file>
    ```
    For ARC execution see section on [ARC Deployment](#arc-deployment).
---
## Adding a pre-trained protein language model to the Virus Host Prediction Pipeline

1. Create a child class of [ProteinSequenceClassification](src/models/protein_sequence_classification.py) within [models](src/models)
2. Implement the `get_embedding()` method that will generate the embeddings for a given batch of protein sequences.
3. The default implementation of `forward()` in [ProteinSequenceClassification](src/models/protein_sequence_classification.py) will do the following - 
   - call the `get_embedding()` method.
   - fine_tune for host prediction using a multi-layer perceptron neural network.